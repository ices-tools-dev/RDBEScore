---
title: "Estimating Population parameters from RDBESRawObjects"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating RDBESRawObjects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction 

The aim of this document is to illustrate how population parameters like total and mean can be estimated using the **estimMC(...)** function.

```{r}
library(icesRDBES)
```

## Prerequisites

First we'll load some example data from the RDBES and check it's valid.  It's a good idea to check your RDBESRawObjects are valid after any manipulations you perform.

```{r load}
h1d <- createRDBESRawObject(rdbesExtractPath = "..\\tests\\testthat\\h1_v_1_19")
h1dValid <- validateRDBESRawObject(h1d, verbose = FALSE)

```

## Multiple Count Estimator

For lower hierarchy tables the number of sampled and measured total 
```{r}
FMidSel <- "254505"
BV <- h1d$BV[h1d$BV$FMid == FMidSel,]
```


```{r}
estimTables <- tablesInRDBESHierarchies$H1[3:9]
estimTables
```

```{r}
head(h1d[[estimTables[1]]])
```

```{r}
getColnames <- function(tblName){
  idCol <- paste0(tblName,"id")
  numSampledCol <- paste0(tblName,"numSamp")
  numTotalCol <- paste0(tblName,"numTotal")
  selMethodCol <- paste0(tblName,"selectMeth")
  c(idCol = idCol, numSampledCol=numSampledCol,  numTotalCol=numTotalCol)
}
estimate<-function(tbl, target){
  tblName <- unique(tbl[[colnames(tbl)[grepl("recType$", colnames(tbl))]]])
  if(length(tblName)>1){stop("Mixed table")}
  cols <- getColnames(tblName)
  missingCols <- setdiff(cols, colnames(tbl))
  missingCols
  
}
gatherData<-function(tbls, ids, target){
  if(length(tbls) == 0) return(NULL)
  tbl <- tbls[[1]]
  tbls[[1]]<-NULL
  if(target %in% colnames(tbl)) return(estimate(tbl, target))
  gatherData(tbls ,ids, target)
}
```

```{r}
gatherData(tbls=h1d[estimTables], ids=c(4874), target = "BVvalueMeas")
```


```{r}

```


```{r}
#END
```

