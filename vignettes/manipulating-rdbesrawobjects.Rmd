---
title: "Manipulating RDBESRawObjects"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Manipulating RDBESRawObjects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction 

The aim of this document is to illustrate some of the ways of manipulating RDBESRawObjects.

```{r}
library(icesRDBES)
```

## Prerequisites

First we'll load some example data from the RDBES and check it's valid.  It's a good tip to check your RDBESRawObjects are valid after any manipulations you perform.

```{r load}

getwd()

# Hierarchy 1 demo data
myH1RawObject <-
     createRDBESRawObject(rdbesExtractPath = "..\\tests\\testthat\\h1_v_1_19")

# Number of rows in each non-null table
unlist(lapply(myH1RawObject, nrow))

validateRDBESRawObject(myH1RawObject, verbose = FALSE)

# Hierarchy 5 demo data
myH5RawObject <-
     createRDBESRawObject(rdbesExtractPath = "..\\tests\\testthat\\h5_v_1_19")

# Number of rows in each non-null table
unlist(lapply(myH5RawObject, nrow))

validateRDBESRawObject(myH5RawObject, verbose = FALSE)


```

## Combining RBDESRawObjects

RDBESRawObjects can be combined using the combineRDBESRawObjects() function.  This might be required when different sampling schemes are used to collect on-shore and at-sea samples - it will normally be required to combine all the data together before further analysis.

```{r combine}

myCombinedRawObject <- combineRDBESRawObjects(rdbesRawObject1=myH1RawObject,
                                              rdbesRawObject2=myH5RawObject)

# Number of rows in each non-null table
unlist(lapply(myCombinedRawObject, nrow))

validateRDBESRawObject(myCombinedRawObject, verbose = FALSE)
```

## Filtering RDBESRawObjects

RDBESRawObjects can be filtered using the filterRDBESRawObject() function - this allows the RDBESRawObject to be filtered by any field.  A typical use of filtering might be to extract all data collected in a particular ICES division.  

It is important to note that filtering is likely to result in "orphan" rows being produced so it is usual to also apply the findAndKillOrphans() function to the filtered data to remove these records.

You can also remove any records that are not linking to a row in the VesselDetails (VD) table using the removeBrokenVesselLinks() function.


```{r filter}
myH1RawObject <-
createRDBESRawObject(rdbesExtractPath = "..\\tests\\testthat\\h1_v_1_19")

# Number of rows in each non-null table
unlist(lapply(myH1RawObject, nrow))

myFields <- c("SDctry","VDctry","VDflgCtry","FTarvLoc")
myValues <- c("ZW","ZWBZH","ZWVFA" )

myFilteredObject <- filterRDBESRawObject(myH1RawObject,
                                         fieldsToFilter = myFields,
                                         valuesToFilter = myValues )


myFilteredObjectNoOrphans <- findAndKillOrphans(objectToCheck = myFilteredObject,
                                        verbose = FALSE)

myFields <- c("VDlenCat")
myValues <- c("18-<24" )
myFilteredObject <- filterRDBESRawObject(myFilteredObjectNoOrphans,
                                         fieldsToFilter = myFields,
                                         valuesToFilter = myValues )

myFilteredObjectValidVesselLinks <- removeBrokenVesselLinks(
                                  objectToCheck = myFilteredObject,
                                  verbose = FALSE)

validateRDBESRawObject(myFilteredObjectNoOrphans, verbose = FALSE)
```



```{r}
#END
```

